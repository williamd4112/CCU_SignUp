<?php

//front-end input format: name="$name[0]"
//									  1
//									  2
//									  3
//									  4
//									  ...
//text,textarea use 0
//select , checkbox use 0 ~ ...
//count of input array must be larger than require	
function validate($fields)
{
  //count of match
  $match = 0;
  //expected count of matching
  $expect = 0;
  foreach($fields as $field){
	if($field->require > 0)
	  $expect++;
	else
	  continue;
	if(isset($field) && !empty($field)){
	  $type = $field->input[0];
	  if($type == 'checkbox'){
		if(isset($_POST[$field->name]) && !empty($_POST[$field->name]))
			if(count($_POST[$field->name]) >= $field->require)
				 $match++;
	  }
	  else{
		if(isset($_POST[$field->name][0]) && !empty($_POST[$field->name][0]))
		  $match++;	
	  }
	}
  }
	
	//totally incomplete
	if($match == 0)
		 return -1;
	
	//totally complete:w
	if($match == $expect)
		return 1;
	//partially
	else
		return 0;
}

function outdate($info)
{
	return (strtotime($info->deadline) < strtotime(date("Y-m-d"))) ? true : false;
}

function validatePOST($fields)
{
	foreach($fields as $field){
	  if(!isset($_POST[$field]) || empty($_POST[$field]))
		return false;
	}
	return true;
}

function run($info , $fields)
{
	if(outdate($info)){
	  	$message = new Message("報名已經截止");
	  	$panel = new Panel(array("返回"=>"button") , "history.back()");
	  	$view = generateView($info , $message.$panel , "outdate");
	  	echo $view;   
	  	exit;
	  }

	  $validation = validate($fields);
	  
	 if($validation > 0){
		//insert into data base
		$sql_query = 'INSERT INTO `'.$info->name.'` (';
		foreach($fields as $index=>$field){
			$sql_query .= '`'.$field->name.'`';
			if(((int)$index + 1) == count($fields))
				$sql_query .= ')';
			else
				$sql_query .= ',';	
		}
		$sql_query .= ' VALUES(';
		foreach($fields as $index=>$field){
			$sql_query .= '\''.$_POST[$field->name][0].'\'';
			if(((int)$index + 1) == count($fields))
				$sql_query .= ');';
			else
				$sql_query .= ',';	
		}
		echo $sql_query;
		$resource = mysql_query($sql_query);
		if(!$resource){
			echo 'query failed';		
		}
		else{
	  		$message = new Message("報名成功");
	  		$panel = new Panel(array("返回"=>"button") , "history.back()");
	  		$view = generateView($info , $message.$panel , "normal");
	  		echo $view;
		}
	}else if($validation < 0){
		$qlist = array();
		foreach($fields as $field)
	  		array_push($qlist , new Quesition($field));
		$content = new Form($qlist);
		$view = generateView($info , $content , "normal");
		echo $view;
	}else{
  		$message = new Message("報名表資料不完整");
  		$panel = new Panel(array("返回"=>"button") , "history.back()");
  		$view = generateView($info , $message.$panel , "error");
  		echo $view;
	} 
}
?>
